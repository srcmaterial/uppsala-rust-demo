<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="An extension trait for chat models with helpers for handling chat sessions. This trait is implemented automatically for all `crate::ChatModel`s."><title>ChatModelExt in kalosm_language_model - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-916cea96.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="kalosm_language_model" data-themes="" data-resource-suffix="" data-rustdoc-version="1.87.0 (17067e9ac 2025-05-09)" data-channel="1.87.0" data-search-js="search-e7298875.js" data-settings-js="settings-d72f25bb.js" ><script src="../static.files/storage-82c7156e.js"></script><script defer src="sidebar-items.js"></script><script defer src="../static.files/main-fb8c74a8.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-893ab5e7.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc trait"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../kalosm_language_model/index.html">kalosm_<wbr>language_<wbr>model</a><span class="version">0.4.1</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Chat<wbr>Model<wbr>Ext</a></h2><h3><a href="#provided-methods">Provided Methods</a></h3><ul class="block"><li><a href="#method.boxed_chat_model" title="boxed_chat_model">boxed_chat_model</a></li><li><a href="#method.boxed_typed_chat_model" title="boxed_typed_chat_model">boxed_typed_chat_model</a></li><li><a href="#method.chat" title="chat">chat</a></li><li><a href="#method.task" title="task">task</a></li></ul><h3><a href="#implementors">Implementors</a></h3></section><div id="rustdoc-modnav"><h2 class="in-crate"><a href="index.html">In crate kalosm_<wbr>language_<wbr>model</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="index.html">kalosm_language_model</a></div><h1>Trait <span class="trait">ChatModelExt</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../src/kalosm_language_model/chat/ext.rs.html#14-195">Source</a> </span></div><pre class="rust item-decl"><code>pub trait ChatModelExt: <a class="trait" href="trait.CreateChatSession.html" title="trait kalosm_language_model::CreateChatSession">CreateChatSession</a> {
    // Provided methods
    fn <a href="#method.chat" class="fn">chat</a>(&amp;self) -&gt; <a class="struct" href="struct.Chat.html" title="struct kalosm_language_model::Chat">Chat</a>&lt;Self&gt;
       <span class="where">where Self: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/clone/trait.Clone.html" title="trait core::clone::Clone">Clone</a></span> { ... }
<span class="item-spacer"></span>    fn <a href="#method.task" class="fn">task</a>(&amp;self, description: impl <a class="trait" href="https://doc.rust-lang.org/1.87.0/alloc/string/trait.ToString.html" title="trait alloc::string::ToString">ToString</a>) -&gt; <a class="struct" href="struct.Task.html" title="struct kalosm_language_model::Task">Task</a>&lt;Self&gt;
       <span class="where">where Self: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/clone/trait.Clone.html" title="trait core::clone::Clone">Clone</a></span> { ... }
<span class="item-spacer"></span>    fn <a href="#method.boxed_chat_model" class="fn">boxed_chat_model</a>(self) -&gt; <a class="struct" href="struct.BoxedChatModel.html" title="struct kalosm_language_model::BoxedChatModel">BoxedChatModel</a>
       <span class="where">where Self: <a class="trait" href="trait.ChatModel.html" title="trait kalosm_language_model::ChatModel">ChatModel</a>&lt;Error: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/error/trait.Error.html" title="trait core::error::Error">Error</a> + 'static, ChatSession: <a class="trait" href="trait.ChatSession.html" title="trait kalosm_language_model::ChatSession">ChatSession</a>&lt;Error: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/error/trait.Error.html" title="trait core::error::Error">Error</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static&gt; + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/clone/trait.Clone.html" title="trait core::clone::Clone">Clone</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static&gt; + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static</span> { ... }
<span class="item-spacer"></span>    fn <a href="#method.boxed_typed_chat_model" class="fn">boxed_typed_chat_model</a>&lt;T&gt;(self) -&gt; <a class="struct" href="struct.BoxedStructuredChatModel.html" title="struct kalosm_language_model::BoxedStructuredChatModel">BoxedStructuredChatModel</a>&lt;T&gt;
       <span class="where">where Self: <a class="trait" href="trait.StructuredChatModel.html" title="trait kalosm_language_model::StructuredChatModel">StructuredChatModel</a>&lt;Self::<a class="associatedtype" href="trait.CreateDefaultChatConstraintsForType.html#associatedtype.DefaultConstraints" title="type kalosm_language_model::CreateDefaultChatConstraintsForType::DefaultConstraints">DefaultConstraints</a>, Error: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/error/trait.Error.html" title="trait core::error::Error">Error</a> + 'static, ChatSession: <a class="trait" href="trait.ChatSession.html" title="trait kalosm_language_model::ChatSession">ChatSession</a>&lt;Error: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/error/trait.Error.html" title="trait core::error::Error">Error</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static&gt; + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/clone/trait.Clone.html" title="trait core::clone::Clone">Clone</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static&gt; + <a class="trait" href="trait.CreateDefaultChatConstraintsForType.html" title="trait kalosm_language_model::CreateDefaultChatConstraintsForType">CreateDefaultChatConstraintsForType</a>&lt;T&gt; + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static,
             T: 'static</span> { ... }
}</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>An extension trait for chat models with helpers for handling chat sessions. This trait is implemented automatically for all <a href="trait.ChatModel.html" title="trait kalosm_language_model::ChatModel"><code>crate::ChatModel</code></a>s.</p>
</div></details><h2 id="provided-methods" class="section-header">Provided Methods<a href="#provided-methods" class="anchor">ยง</a></h2><div class="methods"><details class="toggle method-toggle" open><summary><section id="method.chat" class="method"><a class="src rightside" href="../src/kalosm_language_model/chat/ext.rs.html#17-22">Source</a><h4 class="code-header">fn <a href="#method.chat" class="fn">chat</a>(&amp;self) -&gt; <a class="struct" href="struct.Chat.html" title="struct kalosm_language_model::Chat">Chat</a>&lt;Self&gt;<div class="where">where
    Self: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/clone/trait.Clone.html" title="trait core::clone::Clone">Clone</a>,</div></h4></section></summary><div class="docblock"><p>Create a new chat session with the model.
Letโs start with a simple chat application:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// Before you create a chat session, you need a model. Llama::new_chat will create a good default chat model.
</span><span class="kw">let </span>model = Llama::new_chat().<span class="kw">await</span>.unwrap();
<span class="comment">// Then you can build a chat session that uses that model
</span><span class="kw">let </span><span class="kw-2">mut </span>chat = model.chat()
    <span class="comment">// The builder exposes methods for settings like the system prompt and constraints the bot response must follow
    </span>.with_system_prompt(<span class="string">"The assistant will act like a pirate"</span>);

<span class="kw">loop </span>{
    <span class="comment">// To use the chat session, you need to add messages to it
    </span><span class="kw">let </span><span class="kw-2">mut </span>response_stream = chat(<span class="kw-2">&amp;</span>prompt_input(<span class="string">"\n&gt; "</span>).unwrap());
    <span class="comment">// And then display the response stream to the user
    </span>response_stream.to_std_out().<span class="kw">await</span>.unwrap();
}</code></pre></div>
<p>If you run the application, you may notice that it takes more time for the assistant to start responding to long prompts.
The LLM needs to read and transform the prompt into a format it understands before it can start generating a response.
Kalosm stores that state in a chat session, which can be saved and loaded from the filesystem to make loading existing chat sessions faster.</p>
<p>You can save and load chat sessions from the filesystem using the <a href="trait.ChatSession.html#method.to_bytes" title="method kalosm_language_model::ChatSession::to_bytes"><code>ChatSession::to_bytes</code></a> and [<code>ChatBuilder::from_bytes</code>] methods:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// First, create a model to chat with
</span><span class="kw">let </span>model = Llama::new_chat().<span class="kw">await</span>.unwrap();
<span class="comment">// Then try to load the chat session from the filesystem
</span><span class="kw">let </span>save_path = std::path::PathBuf::from(<span class="string">"./chat.llama"</span>);
<span class="kw">let </span><span class="kw-2">mut </span>chat = model.chat();
<span class="kw">if let </span><span class="prelude-val">Some</span>(old_session) = std::fs::read(<span class="kw-2">&amp;</span>save_path)
    .ok()
    .and_then(|bytes| LlamaChatSession::from_bytes(<span class="kw-2">&amp;</span>bytes).ok())
{
    chat = chat.with_session(old_session);
}

<span class="comment">// Then you can add messages to the chat session as usual
</span><span class="kw">let </span><span class="kw-2">mut </span>response_stream = chat(<span class="kw-2">&amp;</span>prompt_input(<span class="string">"\n&gt; "</span>).unwrap());
<span class="comment">// And then display the response stream to the user
</span>response_stream.to_std_out().<span class="kw">await</span>.unwrap();

<span class="comment">// After you are done, you can save the chat session to the filesystem
</span><span class="kw">let </span>session = chat.session().unwrap();
<span class="kw">let </span>bytes = session.to_bytes().unwrap();
std::fs::write(<span class="kw-2">&amp;</span>save_path, bytes).unwrap();</code></pre></div>
<p>LLMs are powerful because of their generality, but sometimes you need more control over the output. For example, you might want the assistant to start with a certain phrase, or to follow a certain format.</p>
<p>In kalosm, you can use constraints to guide the modelโs response. Constraints are a way to specify the format of the output. When generating with constraints, the model will always respond with the specified format.</p>
<p>Letโs create a chat application that uses constraints to guide the assistantโs response to always start with โYes!โ:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">let </span>model = Llama::new_chat().<span class="kw">await</span>.unwrap();
<span class="comment">// Create constraints that parses Yes! and then stops on the end of the assistant's response
</span><span class="kw">let </span>constraints = LiteralParser::new(<span class="string">"Yes!"</span>)
    .then(model.default_assistant_constraints());
<span class="comment">// Create a chat session with the model and the constraints
</span><span class="kw">let </span><span class="kw-2">mut </span>chat = model.chat();

<span class="comment">// Chat with the user
</span><span class="kw">loop </span>{
    <span class="kw">let </span><span class="kw-2">mut </span>output_stream = chat(<span class="kw-2">&amp;</span>prompt_input(<span class="string">"\n&gt; "</span>).unwrap()).with_constraints(constraints.clone());
    output_stream.to_std_out().<span class="kw">await</span>.unwrap();
}</code></pre></div>
</div></details><details class="toggle method-toggle" open><summary><section id="method.task" class="method"><a class="src rightside" href="../src/kalosm_language_model/chat/ext.rs.html#26-31">Source</a><h4 class="code-header">fn <a href="#method.task" class="fn">task</a>(&amp;self, description: impl <a class="trait" href="https://doc.rust-lang.org/1.87.0/alloc/string/trait.ToString.html" title="trait alloc::string::ToString">ToString</a>) -&gt; <a class="struct" href="struct.Task.html" title="struct kalosm_language_model::Task">Task</a>&lt;Self&gt;<div class="where">where
    Self: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/clone/trait.Clone.html" title="trait core::clone::Clone">Clone</a>,</div></h4></section></summary><div class="docblock"><p>Create a new task with the model.</p>
<h5 id="tasks"><a class="doc-anchor" href="#tasks">ยง</a>Tasks</h5>
<p>Any model that implements <a href="trait.ChatModel.html" title="trait kalosm_language_model::ChatModel"><code>ChatModel</code></a> or <a href="trait.StructuredChatModel.html" title="trait kalosm_language_model::StructuredChatModel"><code>StructuredChatModel</code></a> can be used with tasks to repeatedly perform work with the same system prompt.</p>
<p>You can create a task with the <a href="trait.ChatModelExt.html#method.task" title="method kalosm_language_model::ChatModelExt::task"><code>ChatModelExt::task</code></a> method with a description of the task and then call the task like a function to start generating a response:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>kalosm::language::<span class="kw-2">*</span>;

<span class="attr">#[tokio::main]
</span><span class="kw">async fn </span>main() {
    <span class="kw">let </span>model = Llama::new_chat().<span class="kw">await</span>.unwrap();
    <span class="kw">let </span>task = model.task(<span class="string">"You are an editing assistant who offers suggestions for improving the quality of the text. You will be given some text and will respond with a list of suggestions for how to improve the text."</span>);
    <span class="kw">let </span><span class="kw-2">mut </span>stream = task(<span class="string">"this isnt correct. or is it?"</span>);
    stream.to_std_out().<span class="kw">await</span>.unwrap();
}</code></pre></div>
<p>Once you have the response builder, you can modify it with any of the methods on [<code>ChatResponseBuilder</code>]. For example, you can change the sampler with [<code>ChatResponseBuilder::with_sampler</code>]:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>kalosm::language::<span class="kw-2">*</span>;

<span class="attr">#[tokio::main]
</span><span class="kw">async fn </span>main() {
    <span class="kw">let </span>model = Llama::new_chat().<span class="kw">await</span>.unwrap();
    <span class="kw">let </span>task = model.task(<span class="string">"You are an editing assistant who offers suggestions for improving the quality of the text. You will be given some text and will respond with a list of suggestions for how to improve the text."</span>);
    <span class="kw">let </span><span class="kw-2">mut </span>stream = task(<span class="string">"this isnt correct. or is it?"</span>).with_sampler(GenerationParameters::default());
    stream.to_std_out().<span class="kw">await</span>.unwrap();
}</code></pre></div>
<h6 id="structured-generation"><a class="doc-anchor" href="#structured-generation">ยง</a>Structured Generation</h6>
<p>You can use structured generation to force the output of the task to fit a specific format. Before you add structured generation to the tasks, you need to define a parser.</p>
<h6 id="defining-the-parser"><a class="doc-anchor" href="#defining-the-parser">ยง</a>Defining the parser</h6>
<p>There are a few different ways create a parser for structured generation:</p>
<ol>
<li>Derive a parser for your data</li>
<li>Create a parser from the set of prebuilt combinators</li>
<li>Create a parser from a regex</li>
</ol>
<h6 id="deriving-a-parser-from-a-struct"><a class="doc-anchor" href="#deriving-a-parser-from-a-struct">ยง</a>Deriving a parser from a struct</h6>
<p>The simplest way to get started is to derive a parser for your data:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attr">#[derive(Parse, Clone)]
</span><span class="kw">struct </span>Pet {
    name: String,
    age: u32,
    description: String,
}</code></pre></div>
<p>Then you can generate text that works with the parser in a <a href="https://docs.rs/kalosm/latest/kalosm/language/struct.Task.html"><code>Task</code></a>:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attr">#[tokio::main]
</span><span class="kw">async fn </span>main() {
    <span class="comment">// First create a model
    </span><span class="kw">let </span>model = Llama::new_chat().<span class="kw">await</span>.unwrap();
    <span class="comment">// Then create a parser for your data. Any type that implements the `Parse` trait has the `new_parser` method
    </span><span class="kw">let </span>parser = Pet::new_parser();
    <span class="comment">// Create a task with the constraints
    </span><span class="kw">let </span>task = model.task(<span class="string">"You generate realistic JSON placeholders for pets in the form {\"name\": \"Pet name\", \"age\": 0, \"description\": \"Pet description\"}"</span>)
        <span class="comment">// The task constraints must be clone. If they don't implement Clone, you can wrap them in an Arc
        </span>.with_constraints(Arc::new(parser));
    <span class="comment">// Then run the task
    </span><span class="kw">let </span>pet: Pet = task(<span class="string">"Ruffles is a 3 year old adorable dog"</span>).<span class="kw">await</span>.unwrap();
    <span class="macro">println!</span>(<span class="string">"{pet:?}"</span>);
}</code></pre></div>
<h6 id="creating-a-parser-from-the-set-of-prebuilt-combinators"><a class="doc-anchor" href="#creating-a-parser-from-the-set-of-prebuilt-combinators">ยง</a>Creating a Parser from the Set of Prebuilt Combinators</h6>
<p>Kalosm also provides a set of prebuilt combinators for creating more complex parsers. You can use these combinators to create a parser with a custom format:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>kalosm::language::<span class="kw-2">*</span>;
<span class="kw">use </span>std::sync::Arc;

<span class="attr">#[tokio::main]
</span><span class="kw">async fn </span>main() {
    <span class="comment">// First create a model
    </span><span class="kw">let </span>model = Llama::new_chat().<span class="kw">await</span>.unwrap();
    <span class="comment">// Then create a parser for your custom format
    </span><span class="kw">let </span>parser = LiteralParser::from(<span class="string">"["</span>)
        .ignore_output_then(String::new_parser())
        .then_literal(<span class="string">", "</span>)
        .then(u8::new_parser())
        .then_literal(<span class="string">", "</span>)
        .then(String::new_parser())
        .then_literal(<span class="string">"]"</span>);
    <span class="comment">// Create a task with the constraints
    </span><span class="kw">let </span>task = model.task(<span class="string">"You generate realistic JSON placeholders for pets in the form [\"Pet name\", age number, \"Pet description\"]"</span>)
        <span class="comment">// The task constraints must be clone. If they don't implement Clone, you can wrap them in an Arc
        </span>.with_constraints(Arc::new(parser));
    <span class="comment">// Then run the task
    </span><span class="kw">let </span>((name, age), description) = task(<span class="string">"Ruffles is a 3 year old adorable dog"</span>).<span class="kw">await</span>.unwrap();
    <span class="macro">println!</span>(<span class="string">"{name} {age} {description}"</span>);
}</code></pre></div>
<h6 id="creating-a-parser-from-a-regex"><a class="doc-anchor" href="#creating-a-parser-from-a-regex">ยง</a>Creating a Parser from a Regex</h6>
<p>You can also create a parser from a regex:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>kalosm::language::<span class="kw-2">*</span>;
<span class="kw">use </span>std::sync::Arc;

<span class="attr">#[tokio::main]
</span><span class="kw">async fn </span>main() {
    <span class="comment">// First create a model
    </span><span class="kw">let </span>model = Llama::new_chat().<span class="kw">await</span>.unwrap();
    <span class="comment">// Then create a parser for your data. Any
    </span><span class="kw">let </span>parser = RegexParser::new(<span class="string">r"\[(\w+), (\d+), (\w+)\]"</span>).unwrap();
    <span class="comment">// Create a task with the constraints
    </span><span class="kw">let </span>task = model.task(<span class="string">"You generate realistic JSON placeholders for pets in the form [\"Pet name\", age number, \"Pet description\"]"</span>)
        <span class="comment">// The task constraints must be clone. If they don't implement Clone, you can wrap them in an Arc
        </span>.with_constraints(Arc::new(parser));
    <span class="comment">// Finally, run the task. Unlike derived and custom parsers, regex parsers do not provide a useful output type
    </span>task(<span class="string">"Ruffles is a 3 year old adorable dog"</span>).to_std_out().<span class="kw">await</span>.unwrap();
}</code></pre></div>
<h6 id="tasks-with-constraints"><a class="doc-anchor" href="#tasks-with-constraints">ยง</a>Tasks with Constraints</h6>
<p>Once you have a parser, you can force the model to generate text that conforms to that parser with the <a href="struct.Task.html#method.with_constraints" title="method kalosm_language_model::Task::with_constraints"><code>Task::with_constraints</code></a>:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>kalosm::language::<span class="kw-2">*</span>;
<span class="kw">use </span>std::sync::Arc;

<span class="attr">#[derive(Parse, Clone, Debug)]
</span><span class="kw">struct </span>Pet {
    name: String,
    age: u32,
    description: String,
}

<span class="attr">#[tokio::main]
</span><span class="kw">async fn </span>main() {
    <span class="comment">// First create a model
    </span><span class="kw">let </span>model = Llama::new_chat().<span class="kw">await</span>.unwrap();
    <span class="comment">// Then create a parser for your data.
    // Any type that implements the `Parse` trait has the `new_parser` method
    </span><span class="kw">let </span>parser = Pet::new_parser();
    <span class="comment">// Create a task with the constraints
    </span><span class="kw">let </span>task = model.task(<span class="string">"You generate realistic JSON placeholders for pets in the form {\"name\": \"Pet name\", \"age\": 0, \"description\": \"Pet description\"}"</span>)
            <span class="comment">// The task constraints must be clone. If they don't implement Clone, you can wrap them in an Arc
        </span>.with_constraints(Arc::new(parser));
    <span class="comment">// Then run the task
    </span><span class="kw">let </span>pet: Pet = task(<span class="string">"Ruffles is a 3 year old adorable dog"</span>).<span class="kw">await</span>.unwrap();
    <span class="macro">println!</span>(<span class="string">"{pet:?}"</span>);
}</code></pre></div>
</div></details><details class="toggle method-toggle" open><summary><section id="method.boxed_chat_model" class="method"><a class="src rightside" href="../src/kalosm_language_model/chat/ext.rs.html#92-107">Source</a><h4 class="code-header">fn <a href="#method.boxed_chat_model" class="fn">boxed_chat_model</a>(self) -&gt; <a class="struct" href="struct.BoxedChatModel.html" title="struct kalosm_language_model::BoxedChatModel">BoxedChatModel</a><div class="where">where
    Self: <a class="trait" href="trait.ChatModel.html" title="trait kalosm_language_model::ChatModel">ChatModel</a>&lt;Error: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/error/trait.Error.html" title="trait core::error::Error">Error</a> + 'static, ChatSession: <a class="trait" href="trait.ChatSession.html" title="trait kalosm_language_model::ChatSession">ChatSession</a>&lt;Error: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/error/trait.Error.html" title="trait core::error::Error">Error</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static&gt; + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/clone/trait.Clone.html" title="trait core::clone::Clone">Clone</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static&gt; + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static,</div></h4></section></summary><div class="docblock"><p>Erase the type of the chat model. This can be used to make multiple implementations of
<a href="trait.ChatModel.html" title="trait kalosm_language_model::ChatModel"><code>ChatModel</code></a> compatible with the same type.</p>
<h5 id="example"><a class="doc-anchor" href="#example">ยง</a>Example</h5>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">let </span>model = <span class="kw">loop </span>{
    <span class="kw">let </span>input = prompt_input(<span class="string">"Choose Model (gpt, claude, llama, or phi): "</span>).unwrap();
    <span class="kw">match </span>input.to_lowercase().as_str() {
        <span class="string">"gpt" </span>=&gt; {
            <span class="kw">break </span>OpenAICompatibleChatModel::builder()
                .with_gpt_4o_mini()
                .build()
                .boxed_chat_model()
        }
        <span class="string">"claude" </span>=&gt; {
            <span class="kw">break </span>AnthropicCompatibleChatModel::builder()
                .with_claude_3_5_haiku()
                .build()
                .boxed_chat_model()
        }
        <span class="string">"llama" </span>=&gt; {
            <span class="kw">break </span>Llama::builder()
                .with_source(LlamaSource::llama_3_1_8b_chat())
                .build()
                .<span class="kw">await
                </span>.unwrap()
                .boxed_chat_model()
        }
        <span class="string">"phi" </span>=&gt; {
            <span class="kw">break </span>Llama::builder()
                .with_source(LlamaSource::phi_3_5_mini_4k_instruct())
                .build()
                .<span class="kw">await
                </span>.unwrap()
                .boxed_chat_model()
        }
        <span class="kw">_ </span>=&gt; {}
    }
};

<span class="kw">let </span><span class="kw-2">mut </span>chat = model
    .chat()
    .with_system_prompt(<span class="string">"The assistant will act like a pirate"</span>);

<span class="comment">// Then chat with the session
</span><span class="kw">loop </span>{
    chat(<span class="kw-2">&amp;</span>prompt_input(<span class="string">"\n&gt; "</span>).unwrap())
        .to_std_out()
        .<span class="kw">await
        </span>.unwrap();
}</code></pre></div>
</div></details><details class="toggle method-toggle" open><summary><section id="method.boxed_typed_chat_model" class="method"><a class="src rightside" href="../src/kalosm_language_model/chat/ext.rs.html#176-194">Source</a><h4 class="code-header">fn <a href="#method.boxed_typed_chat_model" class="fn">boxed_typed_chat_model</a>&lt;T&gt;(self) -&gt; <a class="struct" href="struct.BoxedStructuredChatModel.html" title="struct kalosm_language_model::BoxedStructuredChatModel">BoxedStructuredChatModel</a>&lt;T&gt;<div class="where">where
    Self: <a class="trait" href="trait.StructuredChatModel.html" title="trait kalosm_language_model::StructuredChatModel">StructuredChatModel</a>&lt;Self::<a class="associatedtype" href="trait.CreateDefaultChatConstraintsForType.html#associatedtype.DefaultConstraints" title="type kalosm_language_model::CreateDefaultChatConstraintsForType::DefaultConstraints">DefaultConstraints</a>, Error: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/error/trait.Error.html" title="trait core::error::Error">Error</a> + 'static, ChatSession: <a class="trait" href="trait.ChatSession.html" title="trait kalosm_language_model::ChatSession">ChatSession</a>&lt;Error: <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/error/trait.Error.html" title="trait core::error::Error">Error</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static&gt; + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/clone/trait.Clone.html" title="trait core::clone::Clone">Clone</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static&gt; + <a class="trait" href="trait.CreateDefaultChatConstraintsForType.html" title="trait kalosm_language_model::CreateDefaultChatConstraintsForType">CreateDefaultChatConstraintsForType</a>&lt;T&gt; + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sized.html" title="trait core::marker::Sized">Sized</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.87.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static,
    T: 'static,</div></h4></section></summary><div class="docblock"><p>Erase the type of the structured chat model. This can be used to make multiple implementations of
<a href="trait.StructuredChatModel.html" title="trait kalosm_language_model::StructuredChatModel"><code>StructuredChatModel</code></a> compatible with the same type.</p>
<h5 id="example-1"><a class="doc-anchor" href="#example-1">ยง</a>Example</h5>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="comment">// You can derive an efficient parser for your struct with the `Parse` trait
// OpenAI doesn't support root anyof schemas, so we need to wrap the constraints in a struct
</span><span class="attr">#[derive(Parse, Clone, Schema, Deserialize, Debug)]
</span><span class="kw">struct </span>Response {
    action: Action,
}

<span class="attr">#[derive(Parse, Clone, Schema, Deserialize, Debug)]
#[serde(tag = <span class="string">"type"</span>)]
#[serde(content = <span class="string">"data"</span>)]
</span><span class="kw">pub enum </span>Action {
    Do(String),
    Say(String),
}

<span class="kw">let </span>model: BoxedStructuredChatModel&lt;Response&gt; = <span class="kw">loop </span>{
    <span class="kw">let </span>input = prompt_input(<span class="string">"Choose Model (gpt, llama, or phi): "</span>).unwrap();
    <span class="kw">match </span>input.to_lowercase().as_str() {
        <span class="string">"gpt" </span>=&gt; {
            <span class="kw">break </span>OpenAICompatibleChatModel::builder()
                .with_gpt_4o_mini()
                .build()
                .boxed_typed_chat_model()
        }
        <span class="string">"llama" </span>=&gt; {
            <span class="kw">break </span>Llama::builder()
                .with_source(LlamaSource::llama_3_1_8b_chat())
                .build()
                .<span class="kw">await
                </span>.unwrap()
                .boxed_typed_chat_model()
        }
        <span class="string">"phi" </span>=&gt; {
            <span class="kw">break </span>Llama::builder()
                .with_source(LlamaSource::phi_3_5_mini_4k_instruct())
                .build()
                .<span class="kw">await
                </span>.unwrap()
                .boxed_typed_chat_model()
        }
        <span class="kw">_ </span>=&gt; {}
    }
};

<span class="kw">let </span><span class="kw-2">mut </span>chat = model
    .chat()
    .with_system_prompt(<span class="string">"The assistant will act like a pirate. You will respond with either something you do or something you say. Respond with JSON in the format { \"type\": \"Say\", \"data\": \"hello\" } or { \"type\": \"Do\", \"data\": \"run away\" }"</span>);

<span class="comment">// Then chat with the session
</span><span class="kw">loop </span>{
    <span class="kw">let </span><span class="kw-2">mut </span>response = chat(<span class="kw-2">&amp;</span>prompt_input(<span class="string">"\n&gt; "</span>).unwrap()).typed::&lt;Response&gt;();
    response.to_std_out().<span class="kw">await</span>.unwrap();
    <span class="macro">println!</span>(<span class="string">"{:?}"</span>, response.<span class="kw">await</span>);
}</code></pre></div>
</div></details></div><h2 id="implementors" class="section-header">Implementors<a href="#implementors" class="anchor">ยง</a></h2><div id="implementors-list"><section id="impl-ChatModelExt-for-M" class="impl"><a class="src rightside" href="../src/kalosm_language_model/chat/ext.rs.html#197">Source</a><a href="#impl-ChatModelExt-for-M" class="anchor">ยง</a><h3 class="code-header">impl&lt;M: <a class="trait" href="trait.CreateChatSession.html" title="trait kalosm_language_model::CreateChatSession">CreateChatSession</a>&gt; <a class="trait" href="trait.ChatModelExt.html" title="trait kalosm_language_model::ChatModelExt">ChatModelExt</a> for M</h3></section></div><script src="../trait.impl/kalosm_language_model/chat/ext/trait.ChatModelExt.js" async></script></section></div></main></body></html>